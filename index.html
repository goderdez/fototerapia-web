<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Sistema inteligente de an√°lisis de piel y generaci√≥n de par√°metros de fototerapia">
  <title>Fototerapia AI - Sistema de An√°lisis Inteligente</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in { animation: fade-in 0.6s ease-out; }
    html { scroll-behavior: smooth; }
    ::-webkit-scrollbar { width: 10px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 5px; }
    ::-webkit-scrollbar-thumb:hover { background: #818cf8; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useRef, useState } = React;

    // Iconos SVG simples
    const UploadIcon = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
      </svg>
    );

    const DownloadIcon = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
      </svg>
    );

    const CopyIcon = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
      </svg>
    );

    const InfoIcon = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="16" x2="12" y2="12"/>
        <line x1="12" y1="8" x2="12.01" y2="8"/>
      </svg>
    );

    const ZapIcon = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
      </svg>
    );

    const SunIcon = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/>
        <line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/>
        <line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
    );

    const DropletIcon = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
      </svg>
    );

    function FototerapiaApp() {
      const [imageName, setImageName] = useState(null);
      const [imagePreview, setImagePreview] = useState(null);
      const [avgColor, setAvgColor] = useState(null);
      const [phototype, setPhototype] = useState(null);
      const [disease, setDisease] = useState("ulcera_superficial");
      const [settings, setSettings] = useState(null);
      const [copied, setCopied] = useState(false);
      const canvasRef = useRef(null);

      const DISEASES = {
        ulcera_superficial: {
          label: "√ölcera superficial",
          desc: "Cicatrizaci√≥n, reducci√≥n de inflamaci√≥n local",
          ledColor: "#FF6B6B",
          intensity: 70,
          ir_minutes: 10,
          icon: "ü©π"
        },
        acne_leve: {
          label: "Acn√© leve",
          desc: "Reducir inflamaci√≥n y bacterias",
          ledColor: "#4ECDC4",
          intensity: 60,
          ir_minutes: 6,
          icon: "‚ú®"
        },
        dolor_muscular: {
          label: "Dolor muscular / contractura",
          desc: "Mejora circulaci√≥n y reduce dolor",
          ledColor: "#FF8C42",
          intensity: 80,
          ir_minutes: 12,
          icon: "üí™"
        },
        piel_sensible: {
          label: "Piel sensible / enrojecida",
          desc: "Calmar enrojecimiento y sensibilidad",
          ledColor: "#95E1D3",
          intensity: 40,
          ir_minutes: 5,
          icon: "üå∏"
        },
        antiedad: {
          label: "Anti-edad / rejuvenecimiento",
          desc: "Estimular col√°geno y elasticidad",
          ledColor: "#F38181",
          intensity: 65,
          ir_minutes: 8,
          icon: "üåü"
        },
        psoriasis: {
          label: "Psoriasis / dermatitis",
          desc: "Reducir placas y descamaci√≥n",
          ledColor: "#A8E6CF",
          intensity: 55,
          ir_minutes: 9,
          icon: "üçÉ"
        }
      };

      function estimatePhototype(r, g, b) {
        const R = r / 255, G = g / 255, B = b / 255;
        const max = Math.max(R, G, B), min = Math.min(R, G, B);
        const L = (max + min) / 2;
        if (L > 0.75) return "I-II";
        if (L > 0.6) return "III";
        if (L > 0.45) return "IV";
        if (L > 0.3) return "V";
        return "VI";
      }

      function hexFromRGB(r, g, b) {
        const toHex = (v) => {
          const h = Math.round(v).toString(16);
          return h.length === 1 ? "0" + h : h;
        };
        return `#${toHex(r)}${toHex(g)}${toHex(b)}`.toUpperCase();
      }

      async function handleImageFile(file) {
        if (!file) return;
        setImageName(file.name);
        
        const reader = new FileReader();
        reader.onload = (e) => setImagePreview(e.target.result);
        reader.readAsDataURL(file);

        const img = new Image();
        img.src = URL.createObjectURL(file);
        await img.decode();

        const canvas = canvasRef.current;
        const ctx = canvas.getContext("2d");

        const w = 300;
        const h = Math.round((img.height / img.width) * w);
        canvas.width = w;
        canvas.height = h;
        ctx.drawImage(img, 0, 0, w, h);

        const sx = Math.floor(w * 0.35);
        const sy = Math.floor(h * 0.35);
        const sw = Math.max(20, Math.floor(w * 0.3));
        const sh = Math.max(20, Math.floor(h * 0.3));

        const imgData = ctx.getImageData(sx, sy, sw, sh).data;
        let r = 0, g = 0, b = 0, count = 0;
        for (let i = 0; i < imgData.length; i += 4) {
          r += imgData[i];
          g += imgData[i + 1];
          b += imgData[i + 2];
          count++;
        }
        r = r / count;
        g = g / count;
        b = b / count;
        const hex = hexFromRGB(r, g, b);
        setAvgColor({ r: Math.round(r), g: Math.round(g), b: Math.round(b), hex });
        
        const phototypeValue = estimatePhototype(r, g, b);
        setPhototype(phototypeValue);
        computeSettings(disease, phototypeValue);
      }

      function adjustForPhototype(base, phototypeTag) {
        const map = {
          "I-II": { intensityFactor: 1.0, irFactor: 1.0 },
          "III": { intensityFactor: 0.95, irFactor: 0.95 },
          "IV": { intensityFactor: 0.9, irFactor: 0.9 },
          "V": { intensityFactor: 0.8, irFactor: 0.8 },
          "VI": { intensityFactor: 0.75, irFactor: 0.75 }
        };
        const factors = map[phototypeTag] || map.III;
        return {
          ledColor: base.ledColor,
          intensity: Math.round(base.intensity * factors.intensityFactor),
          ir_minutes: Math.max(1, Math.round(base.ir_minutes * factors.irFactor))
        };
      }

      function computeSettings(diseaseKey, phototypeTag) {
        const base = DISEASES[diseaseKey];
        const adj = adjustForPhototype(base, phototypeTag);
        const payload = {
          disease: diseaseKey,
          disease_label: base.label,
          phototype: phototypeTag,
          led: {
            color: adj.ledColor,
            intensity_pct: adj.intensity
          },
          infrared: {
            minutes: adj.ir_minutes
          },
          timestamp: new Date().toISOString(),
          notes: "Par√°metros calculados autom√°ticamente. Validar con profesional de salud antes de usar."
        };
        setSettings(payload);
        return payload;
      }

      function handleDiseaseChange(e) {
        const key = e.target.value;
        setDisease(key);
        if (phototype) {
          computeSettings(key, phototype);
        }
      }

      function downloadJSON() {
        if (!settings) return;
        const blob = new Blob([JSON.stringify(settings, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `fototerapia_${settings.disease}_${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }

      function copyToClipboard() {
        if (!settings) return;
        navigator.clipboard.writeText(JSON.stringify(settings, null, 2));
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4 md:p-8">
          <div className="max-w-7xl mx-auto">
            <div className="text-center mb-8 animate-fade-in">
              <div className="inline-flex items-center gap-3 mb-4">
                <div className="text-yellow-400"><ZapIcon /></div>
                <h1 className="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400">
                  Fototerapia AI
                </h1>
                <div className="text-orange-400"><SunIcon /></div>
              </div>
              <p className="text-slate-300 text-lg max-w-2xl mx-auto">
                Sistema inteligente de an√°lisis de piel y generaci√≥n de par√°metros terap√©uticos
              </p>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
              <div className="lg:col-span-2 bg-white/10 backdrop-blur-lg rounded-2xl p-6 shadow-2xl border border-white/20">
                <div className="flex items-center gap-2 mb-4">
                  <div className="text-cyan-400"><UploadIcon /></div>
                  <h2 className="text-xl font-semibold text-white">An√°lisis de Imagen</h2>
                </div>
                
                <div className="relative">
                  <input
                    type="file"
                    accept="image/*"
                    onChange={(e) => handleImageFile(e.target.files[0])}
                    className="hidden"
                    id="file-upload"
                  />
                  <label
                    htmlFor="file-upload"
                    className="flex flex-col items-center justify-center w-full h-64 border-2 border-dashed border-purple-400/50 rounded-xl cursor-pointer bg-slate-800/50 hover:bg-slate-800/70 transition-all duration-300"
                  >
                    {imagePreview ? (
                      <img src={imagePreview} alt="Preview" className="w-full h-full object-contain rounded-xl" />
                    ) : (
                      <div className="flex flex-col items-center">
                        <div className="text-purple-400 mb-4"><UploadIcon /></div>
                        <p className="text-slate-300 text-lg font-medium">Subir imagen del √°rea a tratar</p>
                        <p className="text-slate-500 text-sm mt-2">PNG, JPG hasta 10MB</p>
                      </div>
                    )}
                  </label>
                </div>
                
                {imageName && (
                  <p className="mt-3 text-sm text-slate-400">üìé {imageName}</p>
                )}
                
                <canvas ref={canvasRef} className="hidden" />
              </div>

              <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 shadow-2xl border border-white/20">
                <div className="flex items-center gap-2 mb-4">
                  <div className="text-cyan-400"><DropletIcon /></div>
                  <h2 className="text-xl font-semibold text-white">Condici√≥n</h2>
                </div>
                
                <select
                  value={disease}
                  onChange={handleDiseaseChange}
                  className="w-full p-3 rounded-xl bg-slate-800/70 text-white border border-purple-400/30 focus:border-purple-400 focus:outline-none transition-all"
                >
                  {Object.keys(DISEASES).map((k) => (
                    <option key={k} value={k}>
                      {DISEASES[k].icon} {DISEASES[k].label}
                    </option>
                  ))}
                </select>

                <div className="mt-4 p-4 bg-slate-800/50 rounded-xl">
                  <p className="text-sm text-slate-400 mb-2">Descripci√≥n:</p>
                  <p className="text-white">{DISEASES[disease].desc}</p>
                </div>

                <div className="mt-4 p-4 bg-amber-500/10 rounded-xl border border-amber-500/30">
                  <div className="flex items-start gap-2">
                    <div className="text-amber-400"><InfoIcon /></div>
                    <div className="text-xs text-amber-200">
                      <p className="font-semibold mb-1">Importante:</p>
                      <ul className="space-y-1">
                        <li>‚Ä¢ IR solo en minutos enteros</li>
                        <li>‚Ä¢ Usar toma inteligente para control</li>
                        <li>‚Ä¢ Validar con profesional</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {settings && (
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 animate-fade-in">
                <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 shadow-2xl border border-white/20">
                  <p className="text-slate-400 text-sm mb-3">Color Promedio</p>
                  <div
                    className="w-full h-24 rounded-xl shadow-lg mb-3 flex items-center justify-center"
                    style={{ backgroundColor: avgColor?.hex }}
                  >
                    <span className="text-white font-mono text-lg font-semibold drop-shadow-lg">
                      {avgColor?.hex}
                    </span>
                  </div>
                  <p className="text-slate-300 text-sm">
                    RGB: {avgColor?.r}, {avgColor?.g}, {avgColor?.b}
                  </p>
                </div>

                <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 shadow-2xl border border-white/20">
                  <p className="text-slate-400 text-sm mb-3">Fototipo</p>
                  <div className="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400 mb-2">
                    {phototype}
                  </div>
                  <p className="text-slate-400 text-xs">Clasificaci√≥n Fitzpatrick</p>
                </div>

                <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 shadow-2xl border border-white/20">
                  <p className="text-slate-400 text-sm mb-3">Par√°metros</p>
                  <div className="space-y-2">
                    <div className="flex items-center gap-2">
                      <div className="w-4 h-4 rounded-full" style={{ backgroundColor: settings.led.color }}></div>
                      <span className="text-white text-sm">LED: {settings.led.color}</span>
                    </div>
                    <p className="text-white text-sm">Intensidad: {settings.led.intensity_pct}%</p>
                    <p className="text-white text-sm">IR: {settings.infrared.minutes} min</p>
                  </div>
                </div>
              </div>
            )}

            {settings && (
              <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 shadow-2xl border border-white/20 mb-6">
                <div className="flex flex-wrap gap-4">
                  <button
                    onClick={copyToClipboard}
                    className="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-cyan-500 to-purple-500 rounded-xl text-white font-semibold hover:from-cyan-600 hover:to-purple-600 transition-all shadow-lg"
                  >
                    <CopyIcon />
                    {copied ? "¬°Copiado!" : "Copiar JSON"}
                  </button>
                  <button
                    onClick={downloadJSON}
                    className="flex items-center gap-2 px-6 py-3 bg-slate-700 rounded-xl text-white font-semibold hover:bg-slate-600 transition-all shadow-lg"
                  >
                    <DownloadIcon />
                    Descargar
                  </button>
                </div>
              </div>
            )}

            <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 shadow-2xl border border-white/20">
              <h3 className="text-xl font-semibold text-white mb-4">üí° C√≥mo usar</h3>
              <ol className="space-y-3 text-slate-300">
                <li className="flex gap-3">
                  <span className="flex-shrink-0 w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold">1</span>
                  <span>Sube una foto del √°rea a tratar</span>
                </li>
                <li className="flex gap-3">
                  <span className="flex-shrink-0 w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold">2</span>
                  <span>Selecciona la condici√≥n a tratar</span>
                </li>
                <li className="flex gap-3">
                  <span className="flex-shrink-0 w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold">3</span>
                  <span>Copia o descarga el JSON con par√°metros</span>
                </li>
                <li className="flex gap-3">
                  <span className="flex-shrink-0 w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold">4</span>
                  <span>Configura tu LED (Philips Hue, LIFX, etc.) con el color e intensidad</span>
                </li>
                <li className="flex gap-3">
                  <span className="flex-shrink-0 w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold">5</span>
                  <span>Programa la toma inteligente para el tiempo de IR indicado</span>
                </li>
              </ol>

              <div className="mt-6 p-4 bg-red-500/10 border border-red-500/30 rounded-xl">
                <p className="text-red-300 text-sm font-semibold mb-2">‚ö†Ô∏è Advertencia de Seguridad</p>
                <p className="text-red-200 text-xs">
                  Este sistema NO reemplaza consulta m√©dica. Los valores son estimaciones heur√≠sticas. 
                  Consulta con un profesional de salud antes de usar. No aplicar en piel infectada o 
                  con condiciones que contraindiquen calor.
                </p>
              </div>
            </div>

            <div className="mt-8 text-center text-slate-500 text-sm">
              <p>Fototerapia AI ‚Ä¢ Sistema de an√°lisis y recomendaci√≥n ‚Ä¢ Uso exclusivo informativo</p>
            </div>
          </div>
        </div>
      );
    }

    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<FototerapiaApp />);
  </script>
</body>
</html>
